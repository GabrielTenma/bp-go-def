name: Go Security Scan

on:
  schedule:
    - cron: '0 2 * * *'  # Daily at 2 AM
  workflow_dispatch:
  push:
    branches: [ main, development ]
  pull_request:
    branches: [ main, development ]

jobs:
  golang-security:
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      security-events: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.3' 
      
      # Gosec - Go security checker
      - name: Run Gosec
        uses: securego/gosec@master
        with:
          args: '-fmt sarif -out gosec-results.sarif ./...'
      
      - name: Upload Gosec SARIF
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: gosec-results.sarif
      
      # Nancy - dependency vulnerability scanner
      - name: Install Nancy
        run: |
          go install github.com/sonatype-nexus-community/nancy@latest
      
      - name: Run Nancy
        run: |
          go list -json -deps ./... | nancy sleuth --output=json > nancy-report.json || true
      
      # Govulncheck - official Go vulnerability checker
      - name: Install Govulncheck
        run: go install golang.org/x/vuln/cmd/govulncheck@latest
      
      - name: Run Govulncheck
        run: |
          govulncheck ./... > govulncheck-report.txt || true
          cat govulncheck-report.txt
      
      # Trivy for Go dependencies scan
      - name: Run Trivy
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
      
      - name: Upload Trivy SARIF
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'
      
      # StaticCheck - linting & bug detection
      - name: Install StaticCheck
        run: go install honnef.co/go/tools/cmd/staticcheck@latest
      
      - name: Run StaticCheck
        run: staticcheck ./... || true
      
      # Go-Critic - advanced linter
      - name: Install Go-Critic
        run: go install github.com/go-critic/go-critic/cmd/gocritic@latest
      
      - name: Run Go-Critic
        run: gocritic check ./... || true
      
      # Organize & commit reports
      - name: Prepare Reports
        if: always()
        run: |
          # Create reports folder if not exists
          mkdir -p security-reports
          
          # Generate timestamp
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          EPOCH=$(date +%s)
          
          # Check scan status
          STATUS="success"
          if grep -q "CRITICAL\|HIGH" govulncheck-report.txt 2>/dev/null || \
             grep -q "CRITICAL\|HIGH" *.json 2>/dev/null; then
            STATUS="alert"
          fi
          
          # Create consolidated report
          REPORT_FILE=".security-reports/scan_${STATUS}_${TIMESTAMP}_${EPOCH}.md"
          
          echo "# Security Scan Report" > $REPORT_FILE
          echo "**Date:** $(date '+%Y-%m-%d %H:%M:%S')" >> $REPORT_FILE
          echo "**Status:** ${STATUS}" >> $REPORT_FILE
          echo "**Epoch:** ${EPOCH}" >> $REPORT_FILE
          echo "" >> $REPORT_FILE
          
          echo "## Govulncheck Results" >> $REPORT_FILE
          echo "\`\`\`" >> $REPORT_FILE
          cat govulncheck-report.txt 2>/dev/null || echo "No results" >> $REPORT_FILE
          echo "\`\`\`" >> $REPORT_FILE
          echo "" >> $REPORT_FILE
          
          echo "## Nancy Results" >> $REPORT_FILE
          echo "\`\`\`json" >> $REPORT_FILE
          cat nancy-report.json 2>/dev/null || echo "{}" >> $REPORT_FILE
          echo "\`\`\`" >> $REPORT_FILE
          echo "" >> $REPORT_FILE
          
          echo "## Gosec Results" >> $REPORT_FILE
          echo "See SARIF file: gosec-results.sarif" >> $REPORT_FILE
          echo "" >> $REPORT_FILE
          
          # Copy SARIF files as well
          cp gosec-results.sarif .security-reports/gosec_${TIMESTAMP}.sarif 2>/dev/null || true
          cp trivy-results.sarif .security-reports/trivy_${TIMESTAMP}.sarif 2>/dev/null || true
          
          echo "Report created: $REPORT_FILE"
      
      # Cleanup old reports (>15 days)
      - name: Cleanup Old Reports
        if: always()
        run: |
          cd security-reports
          
          # Get current epoch
          CURRENT_EPOCH=$(date +%s)
          
          # 15 days in seconds (15 * 24 * 60 * 60)
          FIFTEEN_DAYS=1296000
          
          # Loop through all report files
          for file in scan_*_*.md; do
            if [ -f "$file" ]; then
              # Extract epoch from filename (format: scan_status_datetime_EPOCH.md)
              FILE_EPOCH=$(echo $file | grep -oP '\d{10}(?=\.md)')
              
              if [ ! -z "$FILE_EPOCH" ]; then
                AGE=$((CURRENT_EPOCH - FILE_EPOCH))
                
                if [ $AGE -gt $FIFTEEN_DAYS ]; then
                  echo "Deleting old report: $file (age: $((AGE/86400)) days)"
                  rm -f "$file"
                  
                  # Delete related SARIF files
                  DATETIME=$(echo $file | grep -oP '\d{8}_\d{6}')
                  rm -f "gosec_${DATETIME}.sarif" 2>/dev/null || true
                  rm -f "trivy_${DATETIME}.sarif" 2>/dev/null || true
                fi
              fi
            fi
          done
          
          cd ..
      
      # Commit reports to repo
      - name: Commit Reports
        if: always()
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add .security-reports/
          
          # Check if there are changes
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: security scan report $(date '+%Y-%m-%d %H:%M:%S')"
            git push
          fi

  # Secret scanning
  secret-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Gitleaks Scan
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}